<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>NeuroVision 10.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <style>
        .neuron {
            background: radial-gradient(circle, rgba(64,83,255,0.15) 0%, rgba(0,0,0,0) 70%);
            backdrop-filter: blur(12px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            width: 160px;
            height: 160px;
            border: 2px solid rgba(64,83,255,0.5);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 15px;
            color: white;
            cursor: move;
        }
    </style>
</head>
<body class="h-screen bg-black overflow-hidden">
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50">
        <div class="bg-gray-900/50 p-8 rounded-xl border border-blue-500/30">
            <h2 class="text-2xl mb-4 text-blue-500 font-bold">üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <input id="authKey" type="password" 
                   class="w-96 px-4 py-3 bg-gray-800 rounded-lg text-white mb-4"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ Authorization Key">
            <button onclick="saveAuthKey()"
                    class="w-full bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg transition-all text-white">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="fixed top-4 left-4 flex gap-3 z-50">
        <button onclick="createNeuron()"
                class="px-4 py-2 bg-blue-600/50 hover:bg-blue-600 backdrop-blur-lg rounded-lg text-white">
            + –°–æ–∑–¥–∞—Ç—å –Ω–µ–π—Ä–æ–Ω
        </button>
    </div>

    <div id="workspace" class="h-full w-full relative"></div>

    <script>
        // Configuration
        const CRYPTO_KEY = 'neuro-secure-v10';
        let accessToken = null;

        // Auth Functions
        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        async function getAccessToken(authKey) {
            try {
                const rqUID = uuid.v4();
                const encodedAuthKey = btoa(unescape(encodeURIComponent(authKey)));
                
                const response = await fetch('https://ngw.devices.sberbank.ru:9443/api/v2/oauth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json',
                        'RqUID': rqUID,
                        'Authorization': `Basic ${encodedAuthKey}`
                    },
                    body: new URLSearchParams({ scope: 'GIGACHAT_API_PERS' })
                });

                if(!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + response.status);
                
                const data = await response.json();
                return data.access_token;
                
            } catch (error) {
                console.error('Auth Error:', error);
                alert(error.message);
                showAuthModal();
                throw error;
            }
        }

        function saveAuthKey() {
            try {
                const key = document.getElementById('authKey').value;
                if(!key) throw new Error('–í–≤–µ–¥–∏—Ç–µ Authorization Key');
                
                localStorage.setItem('neuro-auth-key', CryptoJS.AES.encrypt(key, CRYPTO_KEY));
                hideAuthModal();
                initializeApp();
                
            } catch (error) {
                alert(error.message);
            }
        }

        // Neuron Functions
        function createNeuron() {
            try {
                const content = prompt('–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–µ–π—Ä–æ–Ω–∞:');
                if(!content) return;

                const neuronEl = document.createElement('div');
                neuronEl.className = 'neuron';
                neuronEl.textContent = content;
                
                // Positioning
                const workspace = document.getElementById('workspace');
                const rect = workspace.getBoundingClientRect();
                neuronEl.style.left = `${Math.random() * (rect.width - 160)}px`;
                neuronEl.style.top = `${Math.random() * (rect.height - 160)}px`;
                
                // Drag & Drop
                let isDragging = false;
                let startX = 0;
                let startY = 0;
                
                neuronEl.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startX = e.clientX - neuronEl.offsetLeft;
                    startY = e.clientY - neuronEl.offsetTop;
                });

                document.addEventListener('mousemove', (e) => {
                    if(!isDragging) return;
                    neuronEl.style.left = `${e.clientX - startX}px`;
                    neuronEl.style.top = `${e.clientY - startY}px`;
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                // Edit
                neuronEl.addEventListener('dblclick', () => {
                    const newContent = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–π—Ä–æ–Ω:', content);
                    if(newContent) neuronEl.textContent = newContent;
                });

                workspace.appendChild(neuronEl);
                
            } catch (error) {
                console.error('Create Neuron Error:', error);
                alert(error.message);
            }
        }

        // Init
        async function initializeApp() {
            try {
                const encryptedKey = localStorage.getItem('neuro-auth-key');
                if(!encryptedKey) throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                
                const authKey = CryptoJS.AES.decrypt(encryptedKey, CRYPTO_KEY).toString(CryptoJS.enc.Utf8);
                accessToken = await getAccessToken(authKey);
                
                document.querySelectorAll('button').forEach(btn => btn.disabled = false);
                
            } catch (error) {
                showAuthModal();
            }
        }

        window.addEventListener('load', () => {
            if(!localStorage.getItem('neuro-auth-key')) {
                showAuthModal();
            } else {
                initializeApp();
            }
        });
    </script>
</body>
</html>